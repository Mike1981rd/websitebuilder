@{
    ViewData["Title"] = "Website Builder";
    Layout = "_WebsiteBuilderLayout";
}

<div class="website-builder-container">
    @Html.AntiForgeryToken()
    <!-- Builder Top Bar -->
    <div class="builder-topbar">
        <div class="topbar-left">
            <button id="exit-builder-btn" class="btn-icon-text">
                <i class="material-icons">arrow_back</i>
            </button>
            <span class="badge-active">Activa</span>
            <button class="topbar-nav-icon active" data-view="sections" title="Secciones">
                <i class="material-icons">layers</i>
            </button>
            <button class="topbar-nav-icon" data-view="settings" title="Configuración">
                <i class="material-icons">settings</i>
            </button>
            <button class="topbar-nav-icon" data-view="menus" title="Menús">
                <i class="material-icons">menu</i>
            </button>
        </div>
        
        <div class="topbar-center">
            <div class="page-selector">
                <button id="page-selector-trigger" class="page-selector-btn">
                    <span class="page-name"></span>
                    <i class="material-icons">arrow_drop_down</i>
                </button>
            </div>
        </div>
        
        <div class="topbar-right">
            <button class="btn-icon" id="preview-button">
                <i class="material-icons">remove_red_eye</i>
            </button>
            <button class="btn-icon viewport-toggle active" data-viewport="desktop">
                <i class="material-icons">computer</i>
            </button>
            <button class="btn-icon viewport-toggle" data-viewport="mobile">
                <i class="material-icons">smartphone</i>
            </button>
            <button class="btn-icon">
                <i class="material-icons">fullscreen</i>
            </button>
            <button id="save-builder-btn-topbar" class="btn-primary">
                <span class="btn-text"></span>
            </button>
        </div>
    </div>
    
    <!-- Editor Main Area -->
    <div class="editor-main-area">
        <!-- Editor Sidebar Panel -->
        <aside id="editor-sidebar-panel">
            <div id="sidebar-dynamic-content">
                <p class="sidebar-loading-text"></p>
            </div>
        </aside>
        
        <!-- Editor Preview Area -->
        <main id="editor-preview-area">
            <iframe id="preview-iframe" src="@Url.Action("PreviewTemplate", "WebsiteBuilder")" frameborder="0"></iframe>
        </main>
    </div>
</div>

<!-- Menu Fullscreen Modal -->
<div id="menu-fullscreen-modal" class="menu-modal-overlay" style="display: none;">
    <div class="menu-modal-container" id="menu-main-view">
        <!-- Modal Header -->
        <div class="menu-modal-header">
            <div class="header-left">
                <button id="close-menu-modal" class="btn-icon-text">
                    <i class="material-icons">arrow_back</i>
                </button>
                <h1 class="modal-title">
                    <i class="material-icons">menu</i>
                    <span data-i18n="menus.title">Menús</span>
                </h1>
            </div>
            <div class="header-right">
                <span class="redirect-info" data-i18n="menus.redirectsInfo">Redireccionamientos de URL</span>
                <button id="create-menu-btn" class="btn-primary">
                    <span data-i18n="menus.createMenu">Crear menú</span>
                </button>
            </div>
        </div>
        
        <!-- Modal Content -->
        <div class="menu-modal-content">
            <!-- Left Panel - Menu List -->
            <div class="menu-list-panel">
                <div class="menu-selector-wrapper">
                    <label for="menu-selector" data-i18n="menus.menuLabel">Menú</label>
                    <select id="menu-selector" class="menu-dropdown">
                        <option value="all" data-i18n="menus.allMenus">Todos los menús</option>
                        <option value="main" data-i18n="menus.mainMenu">Main menu</option>
                        <option value="footer" data-i18n="menus.footerMenu">Footer menu</option>
                    </select>
                </div>
                
                <div class="menu-items-list" id="menu-items-list">
                    <!-- Menu items will be dynamically loaded here -->
                </div>
            </div>
            
            <!-- Right Panel - Menu Details -->
            <div class="menu-details-panel">
                <h2 class="panel-title" data-i18n="menus.menuItemsTitle">Elementos del menú</h2>
                <div class="menu-details-content" id="menu-details-content">
                    <!-- Menu details will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Menu View -->
    <div class="menu-create-container" id="menu-create-view" style="display: none;">
        <div class="menu-modal-header">
            <div class="header-left">
                <button id="back-to-menus" class="btn-icon-text">
                    <i class="material-icons">arrow_back</i>
                </button>
                <h1 class="modal-title">
                    <i class="material-icons">add</i>
                    <span data-i18n="menus.addMenu">Agregar menú</span>
                </h1>
            </div>
        </div>
        
        <div class="menu-create-content">
            <div class="menu-form-container">
                <div class="form-group">
                    <label for="new-menu-name" data-i18n="menus.menuName">Nombre</label>
                    <input type="text" id="new-menu-name" class="form-control" placeholder="p. ej., Menú de barra lateral">
                </div>
                
                <div class="form-group" style="display: none;">
                    <label data-i18n="menus.handle">Identificador:</label>
                    <div class="handle-display" id="new-menu-handle"></div>
                </div>
                
                <div class="menu-items-section">
                    <h3 data-i18n="menus.menuItems">Elementos del menú</h3>
                    <div id="create-menu-items-container">
                        <!-- Menu items will be added here -->
                    </div>
                    <div id="add-item-form-create" class="add-item-inline-form" style="display: none;">
                        <div class="inline-form-row">
                            <div class="inline-form-field">
                                <label data-i18n="menus.itemLabel">Etiqueta</label>
                                <input type="text" class="menu-item-input" id="new-item-label-create" placeholder="p. ej., Quiénes somos">
                            </div>
                            <div class="inline-form-field">
                                <label data-i18n="menus.itemLink">Enlace</label>
                                <div class="link-input-wrapper">
                                    <input type="text" class="menu-item-input" id="new-item-url-create" placeholder="Busca o pega un enlace">
                                    <button class="link-action-btn cancel-add-item-btn" title="Cancelar">
                                        <i class="material-symbols-outlined">delete</i>
                                    </button>
                                    <div class="link-suggestions-dropdown" id="link-suggestions-create" style="display: none;">
                                        <div class="link-category">
                                            <h4 data-i18n="menus.linkSuggestions.onlineStore">Tienda online</h4>
                                            <ul>
                                                <li data-url="/"><i class="material-icons">home</i><span data-i18n="menus.linkSuggestions.homePage">Página de inicio</span></li>
                                                <li data-url="/search"><i class="material-icons">search</i><span data-i18n="menus.linkSuggestions.search">Búsqueda</span></li>
                                                <li data-url="/collections" class="has-submenu">
                                                    <i class="material-icons">collections</i>
                                                    <span data-i18n="menus.linkSuggestions.collections">Colecciones</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/products" class="has-submenu">
                                                    <i class="material-icons">inventory_2</i>
                                                    <span data-i18n="menus.linkSuggestions.products">Productos</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/pages" class="has-submenu">
                                                    <i class="material-icons">description</i>
                                                    <span data-i18n="menus.linkSuggestions.pages">Páginas</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/blogs" class="has-submenu">
                                                    <i class="material-icons">article</i>
                                                    <span data-i18n="menus.linkSuggestions.blogs">Blogs</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/blog/news" class="has-submenu">
                                                    <i class="material-icons">article</i>
                                                    <span data-i18n="menus.linkSuggestions.blogPosts">Artículos del blog</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/policies" class="has-submenu">
                                                    <i class="material-icons">gavel</i>
                                                    <span data-i18n="menus.linkSuggestions.policies">Políticas</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="link-category">
                                            <h4 data-i18n="menus.linkSuggestions.customerAccount">Cuentas de cliente</h4>
                                            <ul>
                                                <li data-url="/account/orders"><i class="material-icons">receipt_long</i><span data-i18n="menus.linkSuggestions.orders">Pedidos</span></li>
                                                <li data-url="/account/profile"><i class="material-icons">person</i><span data-i18n="menus.linkSuggestions.profile">Perfil</span></li>
                                                <li data-url="/account/settings"><i class="material-icons">settings</i><span data-i18n="menus.linkSuggestions.settings">Configuración</span></li>
                                                <li data-url="/apps" class="has-submenu">
                                                    <i class="material-icons">apps</i>
                                                    <span data-i18n="menus.linkSuggestions.apps">Apps</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="inline-form-actions">
                                <button class="confirm-add-item-btn" id="confirm-add-item-create" title="Agregar">
                                    <i class="material-symbols-outlined">check_circle</i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="add-menu-item-link" id="add-first-item">
                        <i class="material-symbols-outlined">add_circle</i>
                        <span data-i18n="menus.addMenuItem">Agregar elemento del menú</span>
                    </button>
                </div>
                
                <div class="form-actions">
                    <button class="btn-secondary" id="cancel-create-menu" data-i18n="common.cancel">Cancelar</button>
                    <button class="btn-primary" id="save-new-menu" data-i18n="common.save">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Menu View -->
    <div class="menu-edit-container" id="menu-edit-view" style="display: none;">
        <div class="menu-modal-header">
            <div class="header-left">
                <button id="back-from-edit" class="btn-icon-text">
                    <i class="material-icons">arrow_back</i>
                </button>
                <h1 class="modal-title" id="edit-menu-title">
                    <!-- Menu name will be inserted here -->
                </h1>
            </div>
            <div class="header-right">
                <button class="btn-secondary" id="duplicate-menu-btn" data-i18n="menus.duplicate">Duplicar</button>
                <div class="dropdown">
                    <button class="btn-secondary dropdown-trigger" id="menu-actions-btn">
                        <span data-i18n="menus.moreActions">Más acciones</span>
                        <i class="material-icons">arrow_drop_down</i>
                    </button>
                    <div class="dropdown-content" id="menu-actions-dropdown" style="display: none;">
                        <a href="#" class="dropdown-item delete-action" id="delete-menu-action">
                            <i class="material-icons">delete</i>
                            <span data-i18n="menus.deleteMenu">Eliminar menú</span>
                        </a>
                        <a href="#" class="dropdown-item" id="locate-menu-action">
                            <i class="material-icons">location_on</i>
                            <span data-i18n="menus.locate">Localizar</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="menu-edit-content">
            <div class="menu-form-container">
                <div class="form-group">
                    <label for="edit-menu-name" data-i18n="menus.menuName">Nombre</label>
                    <input type="text" id="edit-menu-name" class="form-control">
                </div>
                
                <div class="form-group" style="display: none;">
                    <label data-i18n="menus.handle">Identificador:</label>
                    <div class="handle-display" id="edit-menu-handle"></div>
                </div>
                
                <div class="menu-items-section">
                    <h3 data-i18n="menus.menuItems">Elementos del menú</h3>
                    <div id="edit-menu-items-container">
                        <!-- Menu items will be loaded here -->
                    </div>
                    <div id="add-item-form-edit" class="add-item-inline-form" style="display: none;">
                        <div class="inline-form-row">
                            <div class="inline-form-field">
                                <label data-i18n="menus.itemLabel">Etiqueta</label>
                                <input type="text" class="menu-item-input" id="new-item-label-edit" placeholder="p. ej., Quiénes somos">
                            </div>
                            <div class="inline-form-field">
                                <label data-i18n="menus.itemLink">Enlace</label>
                                <div class="link-input-wrapper">
                                    <input type="text" class="menu-item-input" id="new-item-url-edit" placeholder="Busca o pega un enlace">
                                    <button class="link-action-btn cancel-add-item-btn" title="Cancelar">
                                        <i class="material-symbols-outlined">delete</i>
                                    </button>
                                    <div class="link-suggestions-dropdown" id="link-suggestions-edit" style="display: none;">
                                        <div class="link-category">
                                            <h4 data-i18n="menus.linkSuggestions.onlineStore">Tienda online</h4>
                                            <ul>
                                                <li data-url="/"><i class="material-icons">home</i><span data-i18n="menus.linkSuggestions.homePage">Página de inicio</span></li>
                                                <li data-url="/search"><i class="material-icons">search</i><span data-i18n="menus.linkSuggestions.search">Búsqueda</span></li>
                                                <li data-url="/collections" class="has-submenu">
                                                    <i class="material-icons">collections</i>
                                                    <span data-i18n="menus.linkSuggestions.collections">Colecciones</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/products" class="has-submenu">
                                                    <i class="material-icons">inventory_2</i>
                                                    <span data-i18n="menus.linkSuggestions.products">Productos</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/pages" class="has-submenu">
                                                    <i class="material-icons">description</i>
                                                    <span data-i18n="menus.linkSuggestions.pages">Páginas</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/blogs" class="has-submenu">
                                                    <i class="material-icons">article</i>
                                                    <span data-i18n="menus.linkSuggestions.blogs">Blogs</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/blog/news" class="has-submenu">
                                                    <i class="material-icons">article</i>
                                                    <span data-i18n="menus.linkSuggestions.blogPosts">Artículos del blog</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                                <li data-url="/policies" class="has-submenu">
                                                    <i class="material-icons">gavel</i>
                                                    <span data-i18n="menus.linkSuggestions.policies">Políticas</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="link-category">
                                            <h4 data-i18n="menus.linkSuggestions.customerAccount">Cuentas de cliente</h4>
                                            <ul>
                                                <li data-url="/account/orders"><i class="material-icons">receipt_long</i><span data-i18n="menus.linkSuggestions.orders">Pedidos</span></li>
                                                <li data-url="/account/profile"><i class="material-icons">person</i><span data-i18n="menus.linkSuggestions.profile">Perfil</span></li>
                                                <li data-url="/account/settings"><i class="material-icons">settings</i><span data-i18n="menus.linkSuggestions.settings">Configuración</span></li>
                                                <li data-url="/apps" class="has-submenu">
                                                    <i class="material-icons">apps</i>
                                                    <span data-i18n="menus.linkSuggestions.apps">Apps</span>
                                                    <i class="material-icons submenu-arrow">chevron_right</i>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="inline-form-actions">
                                <button class="confirm-add-item-btn" id="confirm-add-item-edit" title="Agregar">
                                    <i class="material-symbols-outlined">check_circle</i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="add-menu-item-link" id="add-menu-item-edit">
                        <i class="material-symbols-outlined">add_circle</i>
                        <span data-i18n="menus.addMenuItem">Agregar elemento del menú</span>
                    </button>
                </div>
                
                <div class="form-actions">
                    <button class="btn-secondary" id="cancel-edit-menu" data-i18n="common.cancel">Cancelar</button>
                    <button class="btn-primary" id="save-edit-menu" data-i18n="common.save">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>


@section Styles {
    <style>
        /* Override Materialize styles for Website Builder */
        #editor-sidebar-panel input[type="range"] {
            border: none !important;
            margin: 0 !important;
        }
        
        #editor-sidebar-panel select {
            display: block !important;
            height: auto !important;
        }
        
        /* Debug: Make sure content is visible */
        #sidebar-dynamic-content {
            background: #f7f7f7;
            min-height: 100%;
        }
        
    </style>
}

@section Scripts {
    <script src="~/js/website-builder.js?v=@DateTime.Now.Ticks"></script>
    <script>
        // Dynamic font loading
        const loadedFonts = new Set(['Inter', 'Roboto', 'Open Sans', 'Playfair Display', 'Montserrat', 'Lato', 'Poppins']);
        
        function loadGoogleFont(fontName) {
            if (loadedFonts.has(fontName)) return;
            
            const link = document.createElement('link');
            link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/\s+/g, '+')}:wght@400;500;600;700&display=swap`;
            link.rel = 'stylesheet';
            document.head.appendChild(link);
            
            loadedFonts.add(fontName);
        }
        
        // Listen for font changes from custom font selector
        $(document).on('fontChanged', '.font-search-input', function(e, fontType, fontValue) {
            const fontName = window.getFontNameFromValueSafe ? window.getFontNameFromValueSafe(fontValue) : getFontNameFromValue(fontValue);
            if (fontName) {
                loadGoogleFont(fontName);
                
                // Also load the font in the preview iframe
                const previewFrame = document.getElementById('preview-iframe');
                if (previewFrame && previewFrame.contentDocument) {
                    const iframeHead = previewFrame.contentDocument.head;
                    const existingLink = iframeHead.querySelector(`link[href*="${fontName.replace(/\s+/g, '+')}"]`);
                    if (!existingLink) {
                        const link = document.createElement('link');
                        link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/\s+/g, '+')}:wght@400;500;600;700&display=swap`;
                        link.rel = 'stylesheet';
                        iframeHead.appendChild(link);
                    }
                }
            }
        });
        
        // Load initial fonts from saved settings
        function loadInitialFonts() {
            setTimeout(() => {
                if (window.currentGlobalThemeSettings && window.currentGlobalThemeSettings.typography) {
                    const typography = window.currentGlobalThemeSettings.typography;
                    
                    // Load all saved fonts
                    const fontsToLoad = [];
                    if (typography.heading?.font) fontsToLoad.push(typography.heading.font);
                    if (typography.body?.font) fontsToLoad.push(typography.body.font);
                    if (typography.menu?.font) fontsToLoad.push(typography.menu.font);
                    if (typography.product?.font) fontsToLoad.push(typography.product.font);
                    if (typography.buttons?.font) fontsToLoad.push(typography.buttons.font);
                    
                    // Load each unique font
                    const uniqueFonts = [...new Set(fontsToLoad)];
                    uniqueFonts.forEach(fontValue => {
                        const fontName = window.getFontNameFromValueSafe ? window.getFontNameFromValueSafe(fontValue) : getFontNameFromValue(fontValue);
                        if (fontName) {
                            loadGoogleFont(fontName);
                        }
                    });
                }
            }, 1000); // Wait for settings to load
        }
        
        // Call on page load
        loadInitialFonts();
        
        window.getFontNameFromValue = function(fontValue) {
            // Convert font value back to font name
            const fontMap = {
                'abel': 'Abel',
                'archivo': 'Archivo',
                'archivo-narrow': 'Archivo Narrow',
                'arimo': 'Arimo',
                'assistant': 'Assistant',
                'bebas-neue': 'Bebas Neue',
                'cabin': 'Cabin',
                'chivo': 'Chivo',
                'dosis': 'Dosis',
                'fjalla-one': 'Fjalla One',
                'josefin-sans': 'Josefin Sans',
                'karla': 'Karla',
                'libre-franklin': 'Libre Franklin',
                'noto-sans': 'Noto Sans',
                'nunito-sans': 'Nunito Sans',
                'oswald': 'Oswald',
                'oxygen': 'Oxygen',
                'pt-sans': 'PT Sans',
                'raleway': 'Raleway',
                'rubik': 'Rubik',
                'source-sans-pro': 'Source Sans Pro',
                'titillium-web': 'Titillium Web',
                'ubuntu': 'Ubuntu',
                'work-sans': 'Work Sans',
                'arvo': 'Arvo',
                'bitter': 'Bitter',
                'cardo': 'Cardo',
                'cormorant': 'Cormorant',
                'crimson-text': 'Crimson Text',
                'david-libre': 'David Libre',
                'eb-garamond': 'EB Garamond',
                'eczar': 'Eczar',
                'libre-baskerville': 'Libre Baskerville',
                'lora': 'Lora',
                'merriweather': 'Merriweather',
                'noticia-text': 'Noticia Text',
                'noto-serif': 'Noto Serif',
                'pt-serif': 'PT Serif',
                'roboto-slab': 'Roboto Slab',
                'source-serif-pro': 'Source Serif Pro',
                'vollkorn': 'Vollkorn',
                'anonymous-pro': 'Anonymous Pro',
                'fira-mono': 'Fira Mono',
                'ibm-plex-mono': 'IBM Plex Mono',
                'inconsolata': 'Inconsolata',
                'jetbrains-mono': 'JetBrains Mono',
                'noto-sans-mono': 'Noto Sans Mono',
                'roboto-mono': 'Roboto Mono',
                'source-code-pro': 'Source Code Pro',
                'space-mono': 'Space Mono',
                'ubuntu-mono': 'Ubuntu Mono'
            };
            
            return fontMap[fontValue] || fontValue.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
    </script>
}